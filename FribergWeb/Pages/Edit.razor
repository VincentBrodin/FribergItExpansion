@page "/edit/{Id}"
@using System.Data.Common
@attribute [Authorize(Roles = ApiRoles.Admin)]
@inject CarService carService

<div class="w-full h-full flex justify-center items-center overflow-x-hidden">
    <div class="card">
        <div class="card-body">
            @if (Car == null)
            {
                <h2 class="card-title">
                    Not found
                </h2>
            }
            else if (Car.Deleted)
            {
                <h2 class="card-title">
                    Item is deleted :/
                </h2>
                <button @onclick="RestoreCarAsync" class="btn btn-error w-full mt-4">Restore</button>
            }
            else
            {
                <h2 class="card-title">
                    Update @Car.Make @Car.Model @Car.Year
                </h2>
                @if (failed)
                {
                    <p class="text-xl text-red-500">
                        Failed
                    </p>
                }
                <form @onsubmit="HandleUpdate" @formname="update_car_form">
                    <fieldset class="fieldset w-full">
                        <legend class="fieldset-legend">Make</legend>
                        <input class="input w-full" @bind="Model.Make" placeholder="@Car.Make" disabled="@loading" />
                    </fieldset>
                    <fieldset class="fieldset w-full">
                        <legend class="fieldset-legend">Model</legend>
                        <input class="input w-full" @bind="Model.Model" placeholder="@Car.Model" disabled="@loading" />
                    </fieldset>
                    <fieldset class="fieldset w-full">
                        <legend class="fieldset-legend">Year</legend>
                        <input class="input w-full" type="number" @bind="Model.Year" placeholder="@Car.Year"
                            disabled="@loading" />
                    </fieldset>
                    <fieldset class="fieldset w-full">
                        <legend class="fieldset-legend">HorsePower</legend>
                        <input class="input w-full" type="number" @bind="Model.HorsePower" placeholder="@Car.HorsePower"
                            disabled="@loading" />
                    </fieldset>
                    <button type="submit" class="btn btn-primary w-full mt-4" disabled="@loading">Update</button>
                </form>
                <button @onclick="DeleteCarAsync" class="btn btn-error w-full mt-4" disabled="@loading">Delete</button>
                <h3 class="font-bold mt-8 mb-2 text-center">Updates</h3>
                <div class="flex flex-col gap-2 w-full p-4 border bg-base-300 border-base-100 rounded-xl">
                    @foreach (var update in Car.Updates)
                    {
                        <div class="flex flex-col gap-2 bg-base-100 rounded-xl p-2">
                            <div class="flex flex-row gap-2 justify-between">
                                <p class="opacity-75 text-start">[@update.Key]</p>
                                @if (!string.IsNullOrEmpty(update.OldValue) || !string.IsNullOrEmpty(update.NewValue))
                                {
                                    <p class=" text-center">@update.OldValue => @update.NewValue</p>
                                }
                                <p class="opacity-75 text-end">[@update.User.UserName]</p>
                            </div>
                            @if (!NonRollbackKeys.Contains(update.Key))
                            {
                                <button class="btn btn-error">
                                    Rollback
                                </button>
                            }
                        </div>

                    }
                </div>
                <h3 class="font-bold mt-8 mb-2 text-center">Rentals</h3>
                <div class="flex flex-col gap-2 w-full p-4 border bg-base-300 border-base-100 rounded-xl">
                    @foreach (var rental in Car.Rentals)
                    {
                        <div class="flex flex-col gap-2 bg-base-100 rounded-xl p-2">
                            <div class="flex flex-row gap-2 justify-between">
                                <p class="text-start">[@rental.User.UserName]</p>
                                <p class="text-center">From: @rental.Start.ToString()</p>
                                <p class="text-end">To: @rental.End.ToString()</p>
                            </div>
                            <button class="btn btn-error">
                                Remove
                            </button>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;
    public UpdateCarDto Model = new UpdateCarDto();
    public FullCarDto? Car = null;

    public bool loading = true;
    public bool failed = false;

    public static readonly List<string> NonRollbackKeys = new List<string>() {
"created",
"deleted",
"restore",
};
    protected override async Task OnInitializedAsync()
    {
        await GetCarAsync();
        loading = false;
    }

    public async Task HandleUpdate()
    {
        loading = true;
        failed = !await carService.UpdateCarAsync(Id, Model);
        Model = new UpdateCarDto();
        await GetCarAsync();

        loading = false;
    }
    public async Task DeleteCarAsync()
    {
        loading = true;
        failed = !await carService.DeleteCarAsync(Id);
        await GetCarAsync();
        loading = false;
    }

    public async Task RestoreCarAsync()
    {
        loading = true;
        failed = !await carService.RestoreCarAsync(Id);
        await GetCarAsync();
        loading = false;
    }

    public async Task GetCarAsync()
    {
        Car = await carService.GetCarAsync(Id);
        if (Car != null)
        {
            Car.Updates = Car.Updates.OrderBy(u => u.Index).ToList();
        }

    }


}