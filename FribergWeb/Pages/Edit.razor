@page "/edit/{Id}"
@using System.Data.Common
@attribute [Authorize(Roles = ApiRoles.Admin)]
@inject CarService carService
@inject RentalService rentalService

<div class="w-full h-full flex justify-center items-start p-4 overflow-x-hidden">
    <div class="card bg-base-200 shadow-lg hover:shadow-xl transition-shadow flex flex-col w-full max-w-3xl h-full">
        <div class="card-body flex flex-col flex-1 gap-4">
            @if (Car == null)
            {
                <h2 class="card-title text-center">Not found</h2>
            }
            else if (Car.Deleted)
            {
                <h2 class="card-title text-center">Item is deleted :/</h2>
                <button @onclick="RestoreCarAsync" class="btn btn-error w-full mt-4">Restore</button>
            }
            else
            {
                <h2 class="card-title text-center">Update @Car.Make @Car.Model @Car.Year</h2>

                @if (failed)
                {
                    <p class="text-red-500 text-center font-semibold">Update failed!</p>
                }

                <!-- Update Form -->
                <form @onsubmit="HandleUpdate" @formname="update_car_form" class="flex flex-col gap-4">
                    <fieldset class="fieldset w-full">
                        <legend class="fieldset-legend">Make</legend>
                        <input class="input w-full" @bind="Model.Make" placeholder="@Car.Make" disabled="@loading" />
                    </fieldset>
                    <fieldset class="fieldset w-full">
                        <legend class="fieldset-legend">Model</legend>
                        <input class="input w-full" @bind="Model.Model" placeholder="@Car.Model" disabled="@loading" />
                    </fieldset>
                    <fieldset class="fieldset w-full">
                        <legend class="fieldset-legend">Year</legend>
                        <input class="input w-full" type="number" @bind="Model.Year" placeholder="@Car.Year"
                            disabled="@loading" />
                    </fieldset>
                    <fieldset class="fieldset w-full">
                        <legend class="fieldset-legend">HorsePower</legend>
                        <input class="input w-full" type="number" @bind="Model.HorsePower" placeholder="@Car.HorsePower"
                            disabled="@loading" />
                    </fieldset>

                    <button type="submit" class="btn btn-primary w-full mt-auto" disabled="@loading">Update</button>
                </form>

                <button @onclick="DeleteCarAsync" class="btn btn-error w-full mt-2" disabled="@loading">Delete</button>

                <!-- Updates Section -->
                <h3 class="font-bold text-2xl mt-6 mb-4 text-center">Updates</h3>
                <div class="flex flex-col gap-3 w-full">
                    @foreach (var update in Car.Updates)
                    {
                        <div class="card bg-base-300 p-3 rounded-lg shadow-sm flex flex-col gap-2">
                            <p class="font-semibold">@update.Key</p>
                            @if (!string.IsNullOrEmpty(update.OldValue) && !string.IsNullOrEmpty(update.NewValue))
                            {
                                <p>From: @update.OldValue</p>
                                <p>To: @update.NewValue</p>
                            }
                            <p class="font-semibold">By @update.User.UserName</p>
                        </div>
                    }
                </div>

                <!-- Rentals Section -->
                <h3 class="font-bold text-2xl mt-6 mb-4 text-center">Rentals</h3>
                <div class="flex flex-col gap-3 w-full">
                    @foreach (var rental in Car.Rentals)
                    {
                        <div class="card bg-base-300 p-3 rounded-lg shadow-sm flex flex-col gap-2">
                            <p class="font-semibold">@rental.User.UserName</p>
                            <p>From: @rental.Start.ToString("g")</p>
                            <p>To: @rental.End.ToString("g")</p>
                            <button @onclick="() => DeleteRentalAsync(rental.Id)" class="btn btn-error btn-sm mt-2 self-end"
                                disabled="@loading">
                                Delete
                            </button>
                        </div>
                    }
                </div>

            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;
    public UpdateCarDto Model = new UpdateCarDto();
    public FullCarDto? Car = null;

    public bool loading = true;
    public bool failed = false;

    public static readonly List<string> NonRollbackKeys = new List<string>() {
"created",
"deleted",
"restore",
};
    protected override async Task OnInitializedAsync()
    {
        await GetCarAsync();
        loading = false;
    }

    public async Task HandleUpdate()
    {
        loading = true;
        failed = !await carService.UpdateCarAsync(Id, Model);
        Model = new UpdateCarDto();
        await GetCarAsync();

        loading = false;
    }
    public async Task DeleteCarAsync()
    {
        loading = true;
        failed = !await carService.DeleteCarAsync(Id);
        await GetCarAsync();
        loading = false;
    }

    public async Task RestoreCarAsync()
    {
        loading = true;
        failed = !await carService.RestoreCarAsync(Id);
        await GetCarAsync();
        loading = false;
    }

    public async Task GetCarAsync()
    {
        Car = await carService.GetCarAsync(Id);
        if (Car != null)
        {
            Car.Updates = Car.Updates.OrderBy(u => u.Index).ToList();
        }
    }

    public async Task DeleteRentalAsync(string id)
    {
        loading = true;
        await rentalService.DeleteAsync(id);
        await GetCarAsync();
        loading = false;
    }


}