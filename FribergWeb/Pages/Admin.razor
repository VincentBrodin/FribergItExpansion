@page "/admin"
@attribute [Authorize(Roles = ApiRoles.Admin)]
@inject AdminService adminService
@inject RentalService rentalService

<div class="w-full h-full flex justify-center items-start overflow-x-hidden p-4">
    <div class="card bg-base-200 shadow-lg w-full max-w-4xl">
        <div class="card-body flex flex-col gap-6">

            @if (loading)
            {
                <p class="text-center text-xl font-semibold animate-pulse">Loading...</p>
            }
            else
            {
                <h2 class="text-3xl font-bold text-center">Admin Panel</h2>

                <div class="flex flex-col gap-4">
                    @foreach (var user in users!)
                    {
                        <details class="collapse collapse-arrow bg-base-100 border-base-300 border">
                            <summary class="collapse-title font-semibold">
                                <div class="w-full flex flex-row justify-between items-center">
                                    <div class="flex flex-row gap-2 items-center">
                                        <p>@user.FirstName @user.LastName</p>
                                        <p class="opacity-70 text-sm">@user.UserName</p>
                                    </div>

                                    <div class="flex flex-row gap-2 items-center">
                                        @if (user.IsAdmin)
                                        {
                                            <button class="btn btn-warning btn-sm" @onclick="@(() => ToggleAdmin(user.Id))"
                                                disabled="@loading">
                                                Remove Admin
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-primary btn-sm" @onclick="@(() => ToggleAdmin(user.Id))"
                                                disabled="@loading">
                                                Promote to Admin
                                            </button>
                                        }
                                    </div>
                                </div>
                            </summary>
                            <div class="collapse-content text-sm">
                                <h3 class="font-semibold mt-2 mb-2">Rentals</h3>

                                @if (user.Rentals == null || !user.Rentals.Any())
                                {
                                    <p class="opacity-60 text-sm">This user has no rentals.</p>
                                }
                                else
                                {
                                    <div class="flex flex-col gap-3">
                                        @foreach (var rental in user.Rentals)
                                        {
                                            <div
                                                class="card bg-base-200 p-3 rounded-lg shadow-sm flex flex-col md:flex-row md:justify-between md:items-center gap-3">
                                                <div>
                                                    <p class="font-semibold">@rental.Car.Make @rental.Car.Model</p>
                                                    <p class="text-sm opacity-70">@rental.Start.ToString("g") â†’
                                                        @rental.End.ToString("g")</p>
                                                </div>

                                                <button class="btn btn-error btn-sm w-full md:w-auto"
                                                    @onclick="@(() => DeleteRental(rental.Id))" disabled="@loading">
                                                    Delete Rental
                                                </button>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </details>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    public List<FullUserDto>? users = null;
    public bool loading = false;

    protected override async Task OnInitializedAsync()
    {
        loading = true;
        users = await adminService.UsersAsync();
        loading = false;
    }

    public async Task DeleteRental(string rentalId)
    {
        loading = true;
        await rentalService.DeleteAsync(rentalId);
        users = await adminService.UsersAsync(); // reload updated users
        loading = false;
    }

    public async Task ToggleAdmin(string id)
    {
        loading = true;
        await adminService.ToggleAdminAsync(id);
        users = await adminService.UsersAsync();
        loading = false;
    }
}