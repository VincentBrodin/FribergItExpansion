@page "/rent/{Id}"
@using System.Data
@using System.Globalization
@attribute [Authorize]
@inject CarService carService
@inject RentalService rentalService

<div class="w-full h-full flex justify-center items-center overflow-x-hidden">
    <div class="card">
        <div class="card-body">
            @if (Car == null)
            {
                <h2 class="card-title">
                    Not found
                </h2>
            }
            else if (Car.Deleted)
            {
                <h2 class="card-title">
                    Item is deleted :/
                </h2>
            } 
            else if (Rental != null) {
                 <h2 class="card-title">
                    You have rented a @Car.Make @Car.Model @Car.Year
                </h2>
                <div class="flex flex-col items-center">
                    <p>From: @Rental.Start.ToString()</p>
                    <p>To: @Rental.End.ToString()</p>
                </div>
            }
            else
            {
                <h2 class="card-title">
                    Rent @Car.Make @Car.Model @Car.Year
                </h2>
                <form @onsubmit="HandleRent" @formname="rent_car_form">
                    <fieldset class="fieldset w-full">
                        <legend class="fieldset-legend">Start</legend>
                        <input class="input w-full" type="datetime-local" min="@DateTime.Now.ToString()" max="@Model.End.ToString()" @bind="Model.Start" disabled="@loading"/>
                    </fieldset>
                    <fieldset class="fieldset w-full">
                        <legend class="fieldset-legend">End</legend>
                        <input class="input w-full" type="datetime-local" min="@Model.Start.ToString()" @bind="Model.End" disabled="@loading"/>
                    </fieldset>
                    <button type="submit" class="btn btn-primary w-full mt-4" disabled="@loading">Rent</button>
                </form>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string Id {get; set;} = string.Empty;
    public RentCarDto Model = new RentCarDto() {
        Start = DateTime.Now,
        End = DateTime.Now.AddDays(7),
    };
    public FullRentalDto? Rental = null;
    public bool loading = false;
    public FullCarDto? Car = null;

      protected override async Task OnInitializedAsync()
    {
        Car = await carService.GetCarAsync(Id);
    }

     public async Task HandleRent()
    {
        loading = true;
        Rental = await rentalService.RentCarAsync(Id, Model);
        loading = false;
    }
}
